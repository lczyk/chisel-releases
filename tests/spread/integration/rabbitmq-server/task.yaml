summary: Integration tests for RabbitMQ

execute: |
  # These tests only run for amd64 and arm64
  # For this test we also need libc-bin_getconf

  slices="rabbitmq-server_bins libc-bin_getconf"
  rootfs="$(install-slices ${slices})"

  mkdir "$rootfs"/dev "$rootfs"/proc
  mount --bind /proc "$rootfs"/proc
  touch "$rootfs"/dev/null
  chmod 777 "$rootfs"/dev/null
  mkdir -p "$rootfs"/var/lib/rabbitmq/mnesia "$rootfs"/var/log/rabbitmq "$rootfs"/etc/rabbitmq
  chroot "$rootfs" useradd -r -d /var/lib/rabbitmq rabbitmq
  chroot "$rootfs" chown -R rabbitmq /var/lib/rabbitmq /var/log/rabbitmq /etc/rabbitmq
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmqctl version

  # Server test
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmqctl status || echo "RabbitMQ not running"
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmq-server -detached
  sleep 10
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmqctl status && echo "RabbitMQ is running now!"

restore: |
  # Kill the RabbitMQ server, which by default runs on port 25672
  kill `sudo lsof -t -i :25672`
