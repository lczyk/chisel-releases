project: chisel-releases

path: /chisel-releases

environment:
  PROJECT_PATH: /chisel-releases
  SHARED_LIBRARIES: $PROJECT_PATH/tests/spread/lib
  PATH: /snap/bin:$PATH:$SHARED_LIBRARIES
  CHISEL_HACKS: "1"

exclude:
  - .github
  - .git
  - .vscode
  - work
  - rootfs

backends:
  docker:
    type: adhoc
    allocate: |
      function main() {
          flavour=$(echo $SPREAD_SYSTEM | cut -d- -f1,2)
          arch=$(echo $SPREAD_SYSTEM | cut -d- -f3)
          # precompiled docker images for amd64 and arm64
          image="sshd-$flavour-$arch"
          echo "Using image: $image"
      
          # Add random suffix to container name for uniqueness
          random_suffix=$(head /dev/urandom | tr -dc a-f0-9 | head -c8)
          container_name="${SPREAD_SYSTEM}-${random_suffix}"
      
          # remove any existing container with the same name
          docker rm -f $container_name 2>/dev/null || true
      
          docker run \
              --rm \
              --platform "linux/$arch" \
              --privileged \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -e DEBIAN_FRONTEND=noninteractice \
              -e "usr=$SPREAD_SYSTEM_USERNAME" \
              -e "pass=$SPREAD_SYSTEM_PASSWORD" \
              --name "$container_name" \
              -d "$image"
      
          until docker exec "$container_name" pgrep sshd; do sleep 1; done
      
          # Copy precompiled chisel into the container to speed up tests
          if [ "$arch" = "arm64" ]; then
              chisel_path="$HOME/canonical/chisel-cache/chisel-v1.4.0-arm64"
          elif [ "$arch" = "amd64" ]; then
              chisel_path="$HOME/canonical/chisel-cache/chisel-v1.4.0-amd64"
          else
              echo "Unsupported architecture: $arch"
              exit 1
          fi
          if [ ! -f "$chisel_path" ]; then
              echo "Chisel binary not found at $chisel_path"
              exit 1
          fi
          docker cp "$chisel_path" "$container_name:/usr/local/bin/chisel"
      
          ADDRESS "$(docker inspect "$container_name" --format '{{.NetworkSettings.Networks.bridge.IPAddress}}')"
      }
      
      main
    discard: |
      set -e
      
      function main() {
          # we cannot filter by IP address directly, so we need to find the container by inspecting all containers
          local container_name=""
          for cid in $(docker ps -a --filter "network=bridge" --format '{{.ID}}'); do
              cname=$(docker inspect "$cid" --format '{{.Name}}' | sed 's/^\/\(.*\)/\1/')
              cip=$(docker inspect "$cid" --format '{{.NetworkSettings.Networks.bridge.IPAddress}}' || echo "")
              if [ "$cip" == "$SPREAD_SYSTEM_ADDRESS" ]; then
                  container_name="$cname"
                  break
              fi
          done
      
          # If we found a matching container, remove it
          if [ -n "$container_name" ]; then
              echo "Removing container: $container_name"
              docker rm -f "$container_name" 2>/dev/null || true
          else
              echo "No container found with IP address: $SPREAD_SYSTEM_ADDRESS"
              exit 1
          fi
      }
      
      main
    systems:
      - ubuntu-26.04-amd64:
          password: ubuntu
          workers: 4
      - ubuntu-26.04-arm64:
          password: ubuntu
          workers: 4

suites:
  tests/spread/integration/:
    summary: Tests common scenarios